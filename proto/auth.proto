// Authentication service APIs and messages.
//
// This file defines RPCs and messages used by the AuthService to handle
// short-lived one-time-password (OTP) flows, token issuance and refresh,
// and integrations for Telegram-based login. Messages include both
// requests and responses as well as small helper structures used by the
// Telegram flow.

syntax = "proto3";

package auth.v1;

import "google/protobuf/empty.proto";

// AuthService provides authentication-related operations such as sending
// and verifying OTPs, issuing and refreshing tokens, and handling the
// Telegram login flow.
service AuthService {
  // Sends a one-time password (OTP) to the given identifier.
  // The identifier typically represents either a phone number or an email
  // address and `type` indicates which delivery channel to use.
  rpc SendOtp (SendOtpRequest) returns (SendOtpResponse);

  // Verifies the one-time password provided by a client. On success the
  // service issues a new access and refresh token pair for the authenticated user.
  rpc VerifyOtp(VerifyOtpRequest) returns (VerifyOtpResponse);

  // Exchanges a refresh token for a new access/refresh token pair. The
  // service may rotate refresh tokens depending on policy.
  rpc Refresh(RefreshRequest) returns (RefreshResponse);

  // Starts the Telegram login flow and returns an authorization URL that
  // the client should open to continue the flow in Telegram.
  rpc TelegramInit (google.protobuf.Empty) returns (TelegramInitResponse);

  // Validates the Telegram login payload (signature and auth_date) and
  // progresses the login flow. Depending on the account state this RPC
  // may return immediate tokens or a bot deep link instructing the user
  // how to complete signup.
  rpc TelegramVerify (TelegramVerifyRequest) returns (TelegramVerifyResponse);

  // Completes Telegram-based login by binding additional data (for example,
  // a phone number) to a previously started Telegram session.
  rpc TelegramComplete (TelegramCompleteRequest) returns (TelegramCompleteResponse);

  // Consumes a completed Telegram session and issues an access/refresh
  // token pair. This endpoint should be called once per session identifier.
  rpc TelegramConsume (TelegramConsumeRequest) returns (TelegramConsumeResponse);
}

// Request to send an OTP to an identifier (email or phone).
message SendOtpRequest {
  // Target identifier to deliver the OTP (for example "+31612345678" or
  // "user@example.com").
  string identifier = 1;

  // Delivery type for the identifier: commonly "phone" or "email".
  string type = 2;
}

// Response for SendOtp request.
message SendOtpResponse {
  // True when the OTP request was accepted for delivery. This does not
  // guarantee that the recipient has received the message.
  bool ok = 1;
}

// Request to verify an OTP code for a previously targeted identifier.
message VerifyOtpRequest {
  // Identifier that originally received the OTP (must match SendOtp identifier).
  string identifier = 1;

  // Delivery type used when sending the OTP: "phone" or "email".
  string type = 2;

  // OTP code provided by the client.
  string code = 3;
}

// Response returned when an OTP was successfully verified.
message VerifyOtpResponse {
  // Short-lived access token to authenticate future requests.
  string access_token = 1;

  // Long-lived refresh token used to obtain new access tokens.
  string refresh_token = 2;
}

// Request to refresh an access token using a refresh token.
message RefreshRequest {
  // The refresh token previously issued to the client.
  string refresh_token = 1;
}

// Response containing a newly issued token pair.
message RefreshResponse {
  // Newly issued access token.
  string access_token = 1;

  // Newly issued refresh token (may be rotated).
  string refresh_token = 2;
}

// Response for Telegram initialization, containing an authorization URL.
message TelegramInitResponse {
  // HTTPS URL that the client should open for Telegram authorization.
  string url = 1;
}

// Request carrying raw Telegram query parameters returned by Telegram
// during OAuth-style authentication. The service validates signature
// and freshness of the parameters.
message TelegramVerifyRequest {
  // Raw query parameters returned by Telegram (must include `hash` and `auth_date`).
  map<string, string> query = 1;
}

// Result of Telegram verification. The oneof allows returning either a
// deep link instructing the client to continue the flow, or tokens when
// login can be completed immediately.
message TelegramVerifyResponse {
  oneof result {
    // Bot deep link URL to continue or complete the flow (for example
    // to provide a phone number or confirm consent).
    string url = 1;

    // Access token issued when Telegram login can be completed immediately.
    string access_token = 2;

    // Refresh token issued when Telegram login can be completed immediately.
    string refresh_token = 3;
  }
}

// Request to complete a Telegram login by supplying additional required data.
message TelegramCompleteRequest {
  // Session identifier created and returned by the Telegram bot flow.
  string session_id = 1;

  // Optional phone number to bind to the Telegram session (E.164 recommended).
  string phone = 2;
}

// Response returned after completing a Telegram session; the client can
// use the session id to exchange it for tokens.
message TelegramCompleteResponse {
  // Session identifier that can be consumed to obtain tokens.
  string session_id = 1;
}

// Request to exchange a completed Telegram session for token pair.
message TelegramConsumeRequest {
  // Session identifier previously returned from TelegramCompleteResponse.
  string session_id = 1;
}

// Token pair returned when consuming a Telegram session.
message TelegramConsumeResponse {
  // Access token for authenticated requests.
  string access_token = 1;

  // Refresh token to obtain new access tokens.
  string refresh_token = 2;
}